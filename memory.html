<!DOCTYPE html>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<head>
  <link rel="stylesheet" href="memory.css"> 
  <title>Recognition Memory Experiment Framework</title>
  <img src="site/uvicSmall.png" >
  <h1 id="h1">Recognition Memory Experiment Framework</h1>
</head>
<style>
div.backupBoxes{ opacity:0.64; }
div.stimulusPools{ opacity:0.97; }
div.radioButtons{ background-color: lightgray; opacity:0.89;}
</style>
<body>
<canvas id="canvasID" width="800" height="800">Error: HTML5 canvas unupported.</canvas><br>
<div class="stimulusPools"><br>

<div class="radioButtons" style="width: 800px; "> 
Time limit    (mS)   <input type="number" name="isi" min="0" max="10000" step="1000" value="0">
Time interval (mS) <input type="number" name="set" min="0" max="10000" step="1000" value="0">
<br>
N: <input type="number" name="p1n" id="p1n" min="0" max="100" step="1" value="30">
M: <input type="number" name="p1m" id="p1m" min="0" max="100" step="1" value="30">

<input type="radio" id = "p1on" name = "p1" onchange="p1on();"  checked=false><label for="p1on">pool1 on</label>   
<input type="radio" id = "p1of" name = "p1" onchange="p1on();"  checked=true><label for="p1of"> off</label>   
<script type="text/javascript">
/* 
http://viralpatel.net/blogs/dynamic-add-textbox-input-button-radio-element-html-javascript/   
*/
  function p1on() {	var e = document.getElementById('p1on');	console.log( e.checked); }
</script>


N: <input type="number" name="p2n" min="0" max="100" step="1" value="30">
M: <input type="number" name="p2m" min="0" max="100" step="1" value="30">

<input type="radio" id = "p2on" name = "p2" onchange="p2on();"  checked=false><label for="p2on">pool2 on</label>
<input type="radio" id = "p2of" name = "p2" onchange="p2on();"  checked=true><label for="p2of"> off</label>
<script type="text/javascript">
  function p2on() {
			var e = document.getElementById('p2on');
			console.log( e.checked);		
		}
</script>

N: <input type="number" name="p3n" min="0" max="100" step="1" value="30">
M: <input type="number" name="p3m" min="0" max="100" step="1" value="30">

<input type="radio" id = "p3on" name = "p3" onchange="p3on();"  checked=false><label for="p3on">pool3 on</label>
<input type="radio" id = "p3of" name = "p3" onchange="p3on();"  checked=true><label for="p3of"> off</label>
<script type="text/javascript">
  function p3on() {
			var e = document.getElementById('p3on');
			console.log( e.checked);		
		}
</script>

<script src="js/defaultData.js"></script>
<script src="js/keyboardModule.js"></script>

</div>

<textarea rows="7" cols="30" id="stimulusBox1" value = ""></textarea> 
<input type="button" value="default" class="stimPooldefault1" onclick=""/>

<textarea rows="7" cols="30" id="stimulusBox2" value = ""></textarea> 
<input type="button" value="default" class="stimPooldefault2" onclick=""/>

<textarea rows="7" cols="30" id="stimulusBox3" value = ""></textarea> 
<input type="button" value="default" class="stimPooldefault3" onclick=""/>

<br>

<div class="radioButtons" style="width: 800px; "> 
<input type="radio" id = "q1on" name = "q1" onchange="q1on();"  checked=false><label for="q1on">Question on</label>   
<input type="radio" id = "q1of" name = "q1" onchange="q1on();"  checked=true><label for="q1of"> off</label>  
<script type="text/javascript">
  function q1on() { var e = document.getElementById('q1on'); console.log( e.checked);		}
</script>
</div>
<textarea rows="7" cols="30" id="questionBox" value = ""></textarea> 
<input type="button" value="default question" class="questionBox" onclick=""/>

<textarea rows="7" cols="30" id="answerBox" value = ""></textarea> 
<input type="button" value="default response" class="questionBox" onclick=""/>
<br>
</div>


<br>
<div class="backupBoxes">
<textarea rows="7" cols="30" id="backupBox" value = ""></textarea>             
<input type="button" value="backup localStorage" class="backupButton" onclick="backupLocalStorage();"/>
<textarea rows="7" cols="30" id="restoreBox" value = ""></textarea> 
<input type="button" value="restore localStorage" class="restoreButton" onclick="restoreLocalStorage();"/>
</div>
<script src="js/displayKeyCode.js"></script>

<INPUT ONKEYPRESS="javascript:return false;" ID="txtChar" ONKEYDOWN="javascript:return displayKeyCode(event);" TYPE="text" NAME="txtChar">
<script src="js/localStorage.js"></script>
<script src="js/formEventHandlers.js"></script>


<script src="js/colourTransform.js"></script>
<script src="js/util.js"></script>

<script>  
	var canvasHeight = 801;
  var plopSound = new Audio('site/plop.mp3'); 
  
  /* check if localStorage is supported.. should be, for most relatively current browsers. */
  function hasLocalStorage(){ 
    var test = 'test';
    try{
      localStorage.setItem(test, test);
      localStorage.removeItem(test);
      return true;
    }catch(e){
      return(false);
    }
  }
 
  /* keep hooks to our html5 canvas, and canvas.context.. */
  var canvas, ctx; 

  /* check if html5-canvas is supported.. */
  function canvasSupported(){
    canvas = document.getElementsByTagName("canvas")[0];
    ctx = canvas.getContext('2d');
    return( !!(ctx));
  }
   
  /* check that the prerequisites are satisfied, and set up the canvas.. */ 
  function init(){
    setDefaultData();
      
    console.log('checking prerequisites..');
    if(!hasLocalStorage()){
      alert('Error:\nHTML5:localStorage unavailable.\n\nUpdate your browser.');
      return;
    }
    if(!canvasSupported()){
      alert('Error: HTML5 canvas not supported. Please update your browser.');
      return;
    }else{
      ctx.width = 800; 
			ctx.height= canvasHeight; 
    }

    console.log('prerequisites seem to be ok..');
  };

  /* don't pass go without the canvas and localStorage.. */
  init();
  
  
 /* State variables */  //  
  gridContent = {}; 
  
 if(false){
		/* sometimes for debugging, need to clear saved state.. */
		localStorage.removeItem('gridContent');
		localStorage.removeItem('puzzlePieceData');
 } 
  /* 
  
			gridContent	<--- this variable indicates if the grid square:  
			at location:  
					'(' + i.toString() +',' + j.toString() + ')'   (***) 
      is occupied. 
      
      The variable holds a name (a number >=0) of the occupying 
      puzzle piece. If the grid location is empty, the value is 
      set to -1;
      
      gridContent maps from (***) to the index in puzzlePieceData 
			(or -1 if the square (***) is empty..)
  */
   
  puzzlePieceData = new Array( 5 * Math.ceil( ctx.width / 100) * Math.ceil( ctx.height/100));
  /* There's an arbitrary constant in the above array, 
			because when we support deleting/creating, we need to add space 
			(don't have time to implement the appropriate garbage collection 
			on this iteration... 
			
			Ideally re-use tiles without overly creating/deleting... 
  
  */
  
  for( var i=0; i<puzzlePieceData.length; i++){
    puzzlePieceData[i] = { 'text':'' } ; //let's add a 'text' property later.. and other properties. 
  }
  var nextPuzzlePieceName = 0;

  var pickThis = ''; //this gets set to a certain 'cI' if a certain grid element gets picked. 
  var selectedItem = ''; /* Something that gets picked will get selected. You can unselect it by rePicking. */
  var selectedX  = '';
  /* set up keyboard handlers, and keyboard state variables.. */
  var lastKeyPressed = ''; //track the last key pressed (onkeydown).. 

 
		
 
   /* transfer inMemory variable to localStorage.. 
   
   NB variables need to be defined at the top, for this to work..
   
   */
	function varSave(variableName){
		var myValue = eval('JSON.stringify('+variableName+');');
		localStorage.setItem(variableName, myValue);
		//eval('localStorage.setItem('+variableName+',JSON.stringify('+variableName+'));');
		//localStorage.setItem(variableName, eval('JSON.stringify('+variableName+');'));
	}
	
	/* 
			transfer localStorage version to inMemory variable (if available)..
			otherwise, initialize a new localStorage version.. 
			N.B., not really a version: more like a copy!
	
	*/
  function varInit(variableName){  /* init variable, but restore if not already defined... */
		var item = localStorage.getItem(variableName);
		if(item==null){
			/* no localStorage copy to restore-- so, write one:  */
			varSave(variableName);
			eval('console.log('+variableName+');');
			return(eval(variableName));
		}else{
		 /* restore localStorage copy. */
		  eval(variableName+' = JSON.parse(item);');
		  eval('console.log('+variableName+');');
		  return(JSON.parse(item));
		}
	}

	if(true){
		progIter = varInit('progIter');
		if(false)document.getElementById("h1").innerHTML = "Recognition Memory Experiment Framework (iter="+progIter.toString()+")";
		progIter++;
		varSave('progIter');
	}	
  
  var invColor;
  var img = new Image(); 
  img.src = 'site/uvicAerial.jpg';  
  var avgColor = [0.,0.,0.];
  
  
  
  img.onload = function() {
    /* 
      When the background image loads, calculate an approximation 
	to the average colour of the image. Ideally we would use 
	an offscreen canvas or other method to do this, if we had more time.
	
	First: set the canvas size to the background image:
    */
    ctx.width = img.width; 
    ctx.height = img.height;
    
    /* 
      Draw the background image (temporarily) on the canvas. Read the data
	values back in, and sample them to get an approximate average 
	value of the colour of the background image. 
    */
    ctx.drawImage(img, 0, 0); //write bg image to the canvas. 
    var imageData = ctx.getImageData(0, 0, img.width, img.height);
    var pix = imageData.data; //read back the pixel data. 
    var nn = 0;	//count the number of points used in the sample. 
    var nSkip = 7777; 
    /* use a sample/fraction of the image data, to save time.. */
    for (var i = 0; i < pix.length; i+=4) {
      /* Use (1/nSkip) of the image pixels. */
      if( i%nSkip==0){
				var r = 1.*pix[i  ];//red
				var g = 1.*pix[i+1];//green
				var b = 1.*pix[i+2];//blue
				avgColor[0]+=r; avgColor[1]+=g; avgColor[2]+=b; 
				nn+=1.; /* keep track of the number of elements in the sample. */
			}/* Note: pix[i+3] is 'alpha' (the fourth element) */
		}
    /* divide by sample mean to get an approximation of the average: */
    avgColor[0]/=nn;avgColor[1]/=nn; avgColor[2]/=nn;
    /* calculate the inverted colour. */
    invColor = 'rgb(' 
			+(255-Math.floor(avgColor[0])).toString() +','
			+(255-Math.floor(avgColor[1])).toString() +','
			+(255-Math.floor(avgColor[2])).toString() 
			+')'; 
    avgColor = inverseColor( invColor);//represent the original in the same format. 
  } //img.onload = function() 

  ctx.width = 800; 
  ctx.height= canvasHeight;//  800; 


  
  
  /* 
    Disable scroll down when spacebar is pressed
  */
  window.onkeydown = function(e) { 
    return !(e.keyCode == 32);
  };

  /* Check if a string (or character) is all upper case. */
  function allUpperCase(s){
    var ss = s.toString();
    return( ss == ss.toUpperCase());
  }

  
  var shiftKey = false; 
  /*
    
  */


  


  /* set up the keyboard event handling scheme above.. */
  var keyboard = keyboard_module(testing);
  


  /* function to convert window mouse coordinates to canvas mouse coordinates. */
  function windowToCanvas(canvas, x,y){
    var bbox = canvas.getBoundingClientRect();
    return { x:(x-bbox.left)*(canvas.width/bbox.width),
       y:(y-bbox.top) *(canvas.height/bbox.height)};
    /*  
      //Example use of windowToCanvas:  
        canvas.onmousemove=function(e){
          var loc = windowToCanvas(canvas, e.clientX, e.clientY);
        };
      //End example..
    */
  }
  
  //----------------------------------------------------------------------------
var cw=canvas.width;
var ch=canvas.height;
function reOffset(){
  var BB=canvas.getBoundingClientRect();
  offsetX=BB.left;
  offsetY=BB.top;        
}
var offsetX,offsetY;
reOffset();





  
</script>
<script src="js/puzzlePieceGrid.js"></script>
<script src="js/animationLoop.js"></script>

<script src="js/mouseEventListeners.js"></script>
<script src="js/startAnimationLoop.js"></script>
</body>
</html>
